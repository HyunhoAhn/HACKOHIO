<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hawk English Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --osu-scarlet: #BB0000;
            --osu-gray: #666666;
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-card: #0f0f0f;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border-color: #333333;
            --scarlet-dark: #990000;
            --scarlet-light: #dd0000;
            --success-color: #ffffff;
            --warning-color: #ffaa00;
            --shadow-sm: 0 2px 4px rgba(187, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(187, 0, 0, 0.2);
            --shadow-lg: 0 8px 16px rgba(187, 0, 0, 0.3);
            --shadow-xl: 0 12px 24px rgba(187, 0, 0, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 0;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, #1a0000 50%, #000000 100%);
            color: var(--text-primary);
            padding: clamp(32px, 5vw, 48px) clamp(24px, 5vw, 48px);
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--osu-scarlet);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 48%, var(--osu-scarlet) 49%, var(--osu-scarlet) 51%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, var(--osu-scarlet) 49%, var(--osu-scarlet) 51%, transparent 52%);
            background-size: 40px 40px;
            opacity: 0.03;
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 12px;
            font-weight: 800;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            color: var(--osu-scarlet);
            text-shadow: 0 2px 8px rgba(187, 0, 0, 0.5);
        }

        .hawk-logo {
            width: clamp(48px, 8vw, 72px);
            height: auto;
            display: none;
            object-fit: contain;
            filter: drop-shadow(0 2px 8px rgba(187, 0, 0, 0.5));
        }

        .header p {
            opacity: 0.9;
            font-size: clamp(0.9375rem, 2vw, 1.125rem);
            font-weight: 400;
            letter-spacing: 0.02em;
            color: var(--text-secondary);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .setup-section {
            padding: clamp(20px, 4vw, 32px);
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        .setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            width: 100%;
            margin: 0 auto 20px auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            color: var(--osu-scarlet);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-group input,
        .input-group select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--osu-scarlet);
            box-shadow: 0 0 0 3px rgba(187, 0, 0, 0.2);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--osu-scarlet) 0%, var(--scarlet-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--scarlet-light) 0%, var(--osu-scarlet) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #ff3333 0%, #ff0000 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--osu-scarlet);
        }

        .btn-secondary:hover {
            background: var(--osu-scarlet);
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: clamp(24px, 4vw, 40px);
            background: var(--bg-primary);
        }

        .chat-container::-webkit-scrollbar {
            width: 10px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--osu-scarlet);
            border-radius: 5px;
        }

        .chat-messages {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 12px;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            align-items: flex-end;
        }

        .message-ai {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 18px 24px;
            border-radius: 16px;
            line-height: 1.7;
            position: relative;
            box-shadow: var(--shadow-md);
            border: 1px solid transparent;
        }

        .message-user .message-bubble {
            background: linear-gradient(135deg, var(--osu-scarlet) 0%, var(--scarlet-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-ai .message-bubble {
            background: var(--bg-card);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .message-label {
            font-size: 0.8125rem;
            color: var(--osu-scarlet);
            font-weight: 700;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .feedback-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-top: 8px;
            max-width: 75%;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 8px 0;
            transition: all 0.2s ease;
        }

        .feedback-header:hover {
            color: var(--osu-scarlet);
        }

        .feedback-title {
            font-weight: 700;
            color: var(--osu-scarlet);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .feedback-toggle {
            color: var(--osu-scarlet);
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }

        .feedback-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .feedback-content {
            margin-top: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .feedback-content.collapsed {
            display: none;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 14px;
            margin: 20px 0;
        }

        .score-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .score-item:hover {
            border-color: var(--osu-scarlet);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .score-label {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--osu-scarlet);
            text-shadow: 0 2px 4px rgba(187, 0, 0, 0.3);
        }

        .feedback-text {
            padding: 16px;
            background: var(--bg-card);
            border-radius: 10px;
            line-height: 1.8;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .audio-control {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
        }

        .audio-player {
            flex: 1;
            height: 44px;
            border-radius: 8px;
            filter: invert(1) hue-rotate(180deg);
        }

        .audio-btn {
            padding: 10px 20px;
            border: none;
            background: var(--osu-scarlet);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
        }

        .audio-btn:hover {
            background: var(--scarlet-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .audio-btn.paused {
            background: var(--bg-tertiary);
            border: 2px solid var(--osu-scarlet);
        }

        .control-panel {
            padding: clamp(20px, 3vw, 28px);
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-lg);
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.3;
                transform: scale(0.8);
            }
        }

        /* Settings floating button and popover (replaces fixed speed panel) */
        .settings-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--osu-scarlet) 0%, var(--scarlet-dark) 100%);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-xl);
            z-index: 1100;
        }

        .settings-popover {
            position: fixed;
            bottom: 80px;
            right: 24px;
            background: var(--bg-card);
            border: 2px solid var(--osu-scarlet);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            padding: 12px;
            z-index: 1100;
            min-width: 220px;
        }

        .speed-label {
            font-size: 0.8125rem;
            color: var(--osu-scarlet);
            font-weight: 700;
            display: flex;
            align-items: center;
            padding: 0 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .speed-btn {
            padding: 8px 14px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .speed-btn.active {
            background: var(--osu-scarlet);
            color: white;
            border-color: var(--osu-scarlet);
            box-shadow: var(--shadow-md);
        }

        .speed-btn:hover {
            border-color: var(--osu-scarlet);
            color: var(--osu-scarlet);
            transform: translateY(-1px);
        }

        .speed-btn.active:hover {
            color: white;
        }

        /* Loader spinner */
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--osu-scarlet);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden {
            display: none !important;
        }

        .section-disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .message-bubble,
            .feedback-section {
                max-width: 90%;
            }

            .setup-grid {
                grid-template-columns: 1fr;
            }

            .settings-fab {
                bottom: 16px;
                right: 16px;
            }

            .score-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>
                    <img id="brandLogo" class="hawk-logo" alt="Hawk logo"/>
                    HAWK English Practice
                </h1>
                <p>The Ohio State University</p>
            </div>
        </div>

        <div class="main-content">
            <div class="setup-section">
                <div class="setup-grid">
                    <div class="input-group">
                        <label for="topic">Topic</label>
                        <input type="text" id="topic" value="free talk">
                    </div>
                    <div class="input-group">
                        <label for="difficulty">Difficulty</label>
                        <select id="difficulty">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" id="startBtn" onclick="startConversation()">
                        <span>Start Conversation</span>
                    </button>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be added here -->
                </div>
            </div>

            <div class="control-panel" id="controlPanel">
                <span class="recording-indicator hidden" id="recordingIndicator">
                    <span class="recording-dot"></span>
                    Recording
                </span>
                <!-- Recording preview panel (listen before send) -->
                <div class="audio-control hidden" id="previewPanel">
                    <audio class="audio-player" id="previewAudio"></audio>
                    <button class="audio-btn paused" id="previewPlayBtn" onclick="togglePreviewPlayback()">▶ Play</button>
                </div>
                <button class="btn btn-primary hidden" id="recordBtn" onclick="startRecording()">
                    <span>Record</span>
                </button>
                <button class="btn btn-danger hidden" id="stopBtn" onclick="stopRecording()">
                    <span>⏹ Stop</span>
                </button>
                <button class="btn btn-secondary hidden" id="redoBtn" onclick="redoRecording()">
                    <span>Re-record</span>
                </button>
                <button class="btn btn-primary hidden" id="sendBtn" onclick="sendAudio()">
                    <span>Send</span>
                </button>
                <button class="btn btn-danger hidden" id="endBtn" onclick="endConversation()">
                    <span>End Conversation</span>
                </button>
            </div>
        </div>

        <!-- Settings button and popover for speed selection -->
        <div class="settings-fab" id="settingsFab" title="Settings" onclick="toggleSettings(event)">⚙</div>
        <div class="settings-popover hidden" id="settingsPopover">
            <div class="speed-label" style="margin-bottom:8px;">Playback Speed</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="speed-btn" onclick="setPlaybackSpeed(0.75, event)">0.75x</button>
                <button class="speed-btn active" onclick="setPlaybackSpeed(1.0, event)">1.0x</button>
                <button class="speed-btn" onclick="setPlaybackSpeed(1.25, event)">1.25x</button>
                <button class="speed-btn" onclick="setPlaybackSpeed(1.5, event)">1.5x</button>
            </div>
        </div>
    </div>

    <script>
    // const API_BASE_URL = 'https://hawkeng.taeinlee.com/api';
        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1';
    // Optional: set your PNG logo path here (e.g., './logo.png'). Leave empty to hide.
    const LOGO_URL = '';
        
        // Generate unique user ID (UUID v4 for backend validation)
        function generateUserId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c){
                const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
            });
        }

        let userId = generateUserId();
        let conversationId = null;
        let currentTurn = 0;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordedBlob = null;
        let currentPlaybackSpeed = 1.0;
    let settingsOpen = false;
    let previewUrl = null;

        function setPlaybackSpeed(speed, ev) {
            currentPlaybackSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (ev && ev.target) {
                ev.target.classList.add('active');
            } else {
                // fallback highlight by label text
                document.querySelectorAll('.speed-btn').forEach(btn => {
                    if (btn.textContent.trim().startsWith(String(speed))) btn.classList.add('active');
                });
            }
            
            document.querySelectorAll('audio').forEach(audio => {
                audio.playbackRate = speed;
            });

            // close settings popover after selection
            const pop = document.getElementById('settingsPopover');
            if (pop && !pop.classList.contains('hidden')) {
                pop.classList.add('hidden');
                settingsOpen = false;
            }
        }

        function pauseAllAudios() {
            document.querySelectorAll('audio').forEach(a => { try { a.pause(); } catch(e){} });
            // also reset all audio control buttons to Play
            if (typeof setAllAudioButtonsToPlay === 'function') {
                setAllAudioButtonsToPlay();
            }
        }

        function toggleSettings(e) {
            const pop = document.getElementById('settingsPopover');
            if (!pop) return;
            settingsOpen = !settingsOpen;
            pop.classList.toggle('hidden', !settingsOpen);
            // Prevent event from bubbling to document click handler
            if (e) e.stopPropagation();
        }

        // Close settings popover when clicking outside
        document.addEventListener('click', (e) => {
            const pop = document.getElementById('settingsPopover');
            const fab = document.getElementById('settingsFab');
            if (!pop || !fab) return;
            if (settingsOpen && !pop.contains(e.target) && e.target !== fab) {
                pop.classList.add('hidden');
                settingsOpen = false;
            }
        });

        function showLoaderMessage(role, text) {
            const container = document.getElementById('chatMessages');
            const el = document.createElement('div');
            el.className = `message message-${role}`;
            el.innerHTML = `
                <div class="message-label">AI Assistant</div>
                <div class="message-bubble" style="display:flex;align-items:center;gap:10px;">
                    <span class="spinner" aria-hidden="true"></span>
                    <span>${text}</span>
                </div>`;
            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
            return el;
        }

        function toggleFeedback(element) {
            const content = element.nextElementSibling;
            const toggle = element.querySelector('.feedback-toggle');
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function startConversation() {
            const topic = document.getElementById('topic').value;
            const difficulty = document.getElementById('difficulty').value;

            try {
                const loader = showLoaderMessage('ai', 'Preparing greeting…');

                const response = await fetch(`${API_BASE_URL}/conversations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        topic: topic
                    })
                });

                if (!response.ok) {
                    let detail = '';
                    try { const err = await response.json(); detail = err?.detail || ''; } catch {}
                    if (loader && loader.remove) loader.remove();
                    throw new Error(`HTTP error! status: ${response.status}${detail? ' - ' + detail : ''}`);
                }

                const data = await response.json();
                conversationId = data.conversation_id;
                currentTurn = 0;

                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('endBtn').classList.remove('hidden');
                // ensure control panel is active & buttons are in initial state
                const panel = document.getElementById('controlPanel');
                panel.classList.remove('section-disabled');
                const recordBtn = document.getElementById('recordBtn');
                const stopBtn = document.getElementById('stopBtn');
                const sendBtn = document.getElementById('sendBtn');
                recordBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                sendBtn.classList.add('hidden');
                
                document.querySelectorAll('.setup-section input, .setup-section select').forEach(el => {
                    el.disabled = true;
                });

                if (loader && loader.remove) loader.remove();

                addMessage('ai', `
                    <div class="message-label">AI Assistant</div>
                    <div class="message-bubble">
                        ${data.welcome_message_text}
                    </div>
                    <div class="audio-control">
                        <audio class="audio-player" id="firstAudio" src="${data.welcome_message_audio_url || ''}"></audio>
                        <button class="audio-btn paused" id="btn-firstAudio" onclick="toggleAudioPlayback('firstAudio', this)">▶ Play</button>
                    </div>
                `);

                const firstAudio = document.getElementById('firstAudio');
                firstAudio.playbackRate = currentPlaybackSpeed;
                
                // Set up audio state handlers
                firstAudio.onended = () => {
                    const btn = document.getElementById('btn-firstAudio');
                    if (btn) setAudioButtonState(btn, false);
                };
                
                firstAudio.onplay = () => {
                    const btn = document.getElementById('btn-firstAudio');
                    if (btn) setAudioButtonState(btn, true);
                };
                
                firstAudio.onpause = () => {
                    const btn = document.getElementById('btn-firstAudio');
                    if (btn) setAudioButtonState(btn, false);
                };
                
                pauseAllAudios();
                firstAudio.play().then(() => {
                    const btn = document.getElementById('btn-firstAudio');
                    if (btn) setAudioButtonState(btn, true);
                }).catch(() => {
                    const btn = document.getElementById('btn-firstAudio');
                    if (btn) setAudioButtonState(btn, false);
                });

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function setAudioButtonState(button, playing) {
            if (!button) return;
            if (playing) {
                button.textContent = '⏸ Pause';
                button.classList.remove('paused');
            } else {
                button.textContent = '▶ Play';
                button.classList.add('paused');
            }
        }

        function setAllAudioButtonsToPlay() {
            document.querySelectorAll('.audio-btn').forEach(btn => {
                setAudioButtonState(btn, false);
            });
        }

        function toggleAudioPlayback(audioId, button) {
            const audio = document.getElementById(audioId);
            if (!audio) return;
            
            if (audio.paused) {
                pauseAllAudios();
                setAllAudioButtonsToPlay();
                audio.play().then(() => {
                    setAudioButtonState(button, true);
                }).catch(err => {
                    console.error('Audio play error:', err);
                    setAudioButtonState(button, false);
                });
                
                // Update button state when audio ends
                audio.onended = () => {
                    setAudioButtonState(button, false);
                };
            } else {
                audio.pause();
                setAudioButtonState(button, false);
            }
        }

        async function startRecording() {
            try {
                // reset any previous preview
                try {
                    const previewPanel = document.getElementById('previewPanel');
                    const previewAudio = document.getElementById('previewAudio');
                    if (previewPanel) previewPanel.classList.add('hidden');
                    if (previewAudio) {
                        previewAudio.pause();
                        previewAudio.removeAttribute('src');
                        previewAudio.load();
                    }
                    if (previewUrl) {
                        URL.revokeObjectURL(previewUrl);
                        previewUrl = null;
                    }
                    recordedBlob = null;
                    document.getElementById('sendBtn').classList.add('hidden');
                } catch (_) {}

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    // show preview panel with audio
                    const previewPanel = document.getElementById('previewPanel');
                    const previewAudio = document.getElementById('previewAudio');
                    const previewPlayBtn = document.getElementById('previewPlayBtn');
                    if (previewAudio) {
                        if (previewUrl) {
                            URL.revokeObjectURL(previewUrl);
                        }
                        previewUrl = URL.createObjectURL(recordedBlob);
                        previewAudio.src = previewUrl;
                        previewAudio.playbackRate = currentPlaybackSpeed;
                    }
                    if (previewPanel) previewPanel.classList.remove('hidden');
                    if (previewPlayBtn) {
                        previewPlayBtn.textContent = '▶ Play';
                        previewPlayBtn.classList.add('paused');
                    }
                    document.getElementById('sendBtn').classList.remove('hidden');
                    document.getElementById('redoBtn').classList.remove('hidden');
                    document.getElementById('recordBtn').classList.add('hidden');
                };

                mediaRecorder.start();
                document.getElementById('recordBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');
                document.getElementById('recordingIndicator').classList.remove('hidden');
                document.getElementById('sendBtn').classList.add('hidden');
                document.getElementById('redoBtn').classList.add('hidden');

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('recordingIndicator').classList.add('hidden');
            }
        }

        function togglePreviewPlayback() {
            const audio = document.getElementById('previewAudio');
            const btn = document.getElementById('previewPlayBtn');
            if (!audio || !btn) return;
            if (audio.paused) {
                pauseAllAudios();
                audio.play();
                btn.textContent = '⏸ Pause';
                btn.classList.remove('paused');
                
                audio.onended = () => {
                    btn.textContent = '▶ Play';
                    btn.classList.add('paused');
                };
            } else {
                audio.pause();
                btn.textContent = '▶ Play';
                btn.classList.add('paused');
            }
        }

        function redoRecording() {
            // clear current preview and blob, then start a new recording
            try {
                const previewPanel = document.getElementById('previewPanel');
                const previewAudio = document.getElementById('previewAudio');
                const previewPlayBtn = document.getElementById('previewPlayBtn');
                if (previewAudio) {
                    previewAudio.pause();
                    previewAudio.removeAttribute('src');
                    previewAudio.load();
                }
                if (previewUrl) {
                    URL.revokeObjectURL(previewUrl);
                    previewUrl = null;
                }
                recordedBlob = null;
                document.getElementById('sendBtn').classList.add('hidden');
                document.getElementById('redoBtn').classList.add('hidden');
                if (previewPanel) previewPanel.classList.add('hidden');
                if (previewPlayBtn) {
                    previewPlayBtn.textContent = 'Play';
                    previewPlayBtn.classList.add('paused');
                }
            } catch (_) {}
            startRecording();
        }

        async function sendAudio() {
            if (!recordedBlob) return;

            currentTurn++;
            const formData = new FormData();
            formData.append('turn_number', currentTurn);
            formData.append('audio_file', recordedBlob, `turn_${currentTurn}.wav`);

            try {
                const loader = showLoaderMessage('ai', 'Analyzing your speech & preparing response…');

                const response = await fetch(`${API_BASE_URL}/conversations/${conversationId}/turns`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    if (loader && loader.remove) loader.remove();
                    let detail = '';
                    try { const err = await response.json(); detail = err?.detail || ''; } catch {}
                    throw new Error(`HTTP error! status: ${response.status}${detail? ' - ' + detail : ''}`);
                }

                const data = await response.json();
                if (loader && loader.remove) loader.remove();
                
                // Add user message
                addMessage('user', `
                    <div class="message-label">You</div>
                    <div class="message-bubble">
                        ${data.user_text}
                    </div>
                `);

                // Add feedback
                const feedbackId = `feedback-${currentTurn}`;
                const feedbackAudioId = `feedback-audio-${currentTurn}`;
                const responseAudioId = `response-audio-${currentTurn}`;
                
                addMessage('ai', `
                    <div class="message-label">Assessment</div>
                    <div class="feedback-section">
                        <div class="feedback-header" onclick="toggleFeedback(this)">
                            <span class="feedback-title">Pronunciation Analysis</span>
                            <span class="feedback-toggle">▼</span>
                        </div>
                        <div class="feedback-content" id="${feedbackId}">
                            <div class="score-grid">
                                <div class="score-item">
                                    <div class="score-label">Pronunciation</div>
                                    <div class="score-value">${data.feedback?.pronunciation_score || 'N/A'}</div>
                                </div>
                                <div class="score-item">
                                    <div class="score-label">Vocabulary</div>
                                    <div class="score-value">${data.feedback?.vocabulary_score || 'N/A'}</div>
                                </div>
                                <div class="score-item">
                                    <div class="score-label">Grammar</div>
                                    <div class="score-value">${data.feedback?.grammar_score || 'N/A'}</div>
                                </div>
                                <div class="score-item">
                                    <div class="score-label">Fluency</div>
                                    <div class="score-value">${data.feedback?.fluency_score || 'N/A'}</div>
                                </div>
                            </div>
                            <div class="feedback-text">
                                ${data.feedback?.overall_comment || 'N/A'}
                            </div>
                            ${data.feedback?.strengths ? `
                            <div class="feedback-text" style="background: rgba(0, 255, 0, 0.05); border-left: 3px solid var(--success-color);">
                                <strong style="color: var(--success-color); display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">✓ Strengths</strong>
                                ${Object.entries(data.feedback.strengths).map(([category, points]) => `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: var(--text-primary); text-transform: capitalize;">${category}:</strong>
                                        <ul style="margin: 4px 0 0 20px; color: var(--text-secondary);">
                                            ${Array.isArray(points) ? points.map(point => `<li>${point}</li>`).join('') : ''}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            ${data.feedback?.improvements ? `
                            <div class="feedback-text" style="background: rgba(255, 170, 0, 0.05); border-left: 3px solid var(--warning-color);">
                                <strong style="color: var(--warning-color); display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">⚠ Areas for Improvement</strong>
                                ${Object.entries(data.feedback.improvements).map(([category, points]) => `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: var(--text-primary); text-transform: capitalize;">${category}:</strong>
                                        <ul style="margin: 4px 0 0 20px; color: var(--text-secondary);">
                                            ${Array.isArray(points) ? points.map(point => `<li>${point}</li>`).join('') : ''}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            <div class="audio-control">
                                <audio class="audio-player" id="${feedbackAudioId}" src="${data.feedback_audio_url || ''}"></audio>
                                <button class="audio-btn paused" id="btn-${feedbackAudioId}" onclick="toggleAudioPlayback('${feedbackAudioId}', this)">▶ Play</button>
                            </div>
                        </div>
                    </div>
                `);

                // Add AI response
                addMessage('ai', `
                    <div class="message-label">AI Assistant</div>
                    <div class="message-bubble">
                        ${data.llm_response_text || 'N/A'}
                    </div>
                    <div class="audio-control">
                        <audio class="audio-player" id="${responseAudioId}" src="${data.llm_response_audio_url || ''}"></audio>
                        <button class="audio-btn paused" id="btn-${responseAudioId}" onclick="toggleAudioPlayback('${responseAudioId}', this)">▶ Play</button>
                    </div>
                `);

                // Auto-play feedback audio
                const feedbackAudio = document.getElementById(feedbackAudioId);
                const responseAudio = document.getElementById(responseAudioId);
                
                feedbackAudio.playbackRate = currentPlaybackSpeed;
                responseAudio.playbackRate = currentPlaybackSpeed;
                
                // Set up audio event handlers for proper state management
                feedbackAudio.onplay = () => {
                    const fbtn = document.getElementById(`btn-${feedbackAudioId}`);
                    if (fbtn) setAudioButtonState(fbtn, true);
                };
                
                feedbackAudio.onpause = () => {
                    const fbtn = document.getElementById(`btn-${feedbackAudioId}`);
                    if (fbtn) setAudioButtonState(fbtn, false);
                };
                
                feedbackAudio.onended = () => {
                    const fbtn = document.getElementById(`btn-${feedbackAudioId}`);
                    if (fbtn) setAudioButtonState(fbtn, false);
                    
                    // Collapse feedback and play response
                    document.getElementById(feedbackId).classList.add('collapsed');
                    document.querySelector(`#${feedbackId}`).previousElementSibling.querySelector('.feedback-toggle').classList.add('collapsed');
                    pauseAllAudios();
                    setAllAudioButtonsToPlay();
                    responseAudio.play().catch(err => console.error('Response audio play error:', err));
                };
                
                responseAudio.onplay = () => {
                    const rbtn = document.getElementById(`btn-${responseAudioId}`);
                    if (rbtn) setAudioButtonState(rbtn, true);
                };
                
                responseAudio.onpause = () => {
                    const rbtn = document.getElementById(`btn-${responseAudioId}`);
                    if (rbtn) setAudioButtonState(rbtn, false);
                };
                
                responseAudio.onended = () => {
                    const rbtn = document.getElementById(`btn-${responseAudioId}`);
                    if (rbtn) setAudioButtonState(rbtn, false);
                };
                
                pauseAllAudios();
                setAllAudioButtonsToPlay();
                feedbackAudio.play().catch(err => console.error('Feedback audio play error:', err));

                // clear preview and reset UI
                try {
                    const previewPanel = document.getElementById('previewPanel');
                    const previewAudio = document.getElementById('previewAudio');
                    const previewPlayBtn = document.getElementById('previewPlayBtn');
                    if (previewAudio) {
                        previewAudio.pause();
                        previewAudio.removeAttribute('src');
                        previewAudio.load();
                    }
                    if (previewUrl) {
                        URL.revokeObjectURL(previewUrl);
                        previewUrl = null;
                    }
                    if (previewPanel) previewPanel.classList.add('hidden');
                    if (previewPlayBtn) {
                        previewPlayBtn.textContent = 'Play';
                        previewPlayBtn.classList.add('paused');
                    }
                } catch (_) {}
                recordedBlob = null;
                document.getElementById('sendBtn').classList.add('hidden');
                document.getElementById('redoBtn').classList.add('hidden');
                document.getElementById('recordBtn').classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function endConversation() {
            if (!conversationId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/conversations/${conversationId}/end`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Display the summary message
                addMessage('ai', `
                    <div class="message-label">Summary</div>
                    <div class="message-bubble">
                        ${data?.summary_text || JSON.stringify(data, null, 2)}
                    </div>
                `);

                // Reset UI state
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('endBtn').classList.add('hidden');
                document.getElementById('recordBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('sendBtn').classList.add('hidden');
                document.getElementById('controlPanel').classList.add('section-disabled');
                
                // Re-enable setup inputs
                document.querySelectorAll('.setup-section input, .setup-section select').forEach(el => {
                    el.disabled = false;
                });

                // Reset conversation state
                conversationId = null;
                currentTurn = 0;
                recordedBlob = null;

            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Initialize logo on load
        document.addEventListener('DOMContentLoaded', () => {
            const logo = document.getElementById('brandLogo');
            if (LOGO_URL && logo) {
                logo.src = LOGO_URL;
                logo.style.display = 'block';
                logo.addEventListener('error', () => { logo.style.display = 'none'; });
            }
        });
    </script>
</body>
</html>